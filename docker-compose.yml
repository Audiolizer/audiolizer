version: "3.7"

services:
  # nginx-proxy:
  #   build: nginx
  #   restart: always
  #   volumes:
  #     - ./nginx/default.conf:/tmp/default.conf
  #   environment: 
  #     - FLASK_SERVER_ADDR=audiolizer:8000
  #   ports:
  #     - "80:80"
  #   depends_on:
  #     - audiolizer
  #   healthcheck:
  #     test: ["CMD-SHELL", "curl --silent --fail localhost:80/health-check || exit 1"]
  #     interval: 10s
  #     timeout: 10s
  #     retries: 3
  #   command: /app/start.sh

  # redis:
  #   image: "redis:alpine"
  #   ports:
  #     - "6379:6379"

  audiolizer:
    image: apembroke/audiolizer:0.4.9
    ports:
      - "8000:5000"
    environment:
      AUDIOLIZER_TEMP: /home/audiolizer/audiolizer/history
    command: ["gunicorn", "--workers=4", "--bind", "0.0.0.0:5000", "audiolizer:server"]
    volumes:
      - type: bind
        source: ${PWD}
        target: /home/audiolizer
    working_dir: /home/audiolizer/audiolizer

  audiolizer-dev:
    image: apembroke/audiolizer:latest
    ports:
      - "80:8050"
      - "8888:8888"
    environment:
      AUDIOLIZER_TEMP: /home/audiolizer/audiolizer/history
    command: ["python", "audiolizer.py"] # runs on port 8051
    # command: ["jupyter", "notebook", "audiolizer.py", "--port=8888", "--no-browser", "--ip=0.0.0.0", "--allow-root"]
    volumes:
      - type: bind
        source: ${PWD}
        target: /home/audiolizer
    working_dir: /home/audiolizer/audiolizer

        