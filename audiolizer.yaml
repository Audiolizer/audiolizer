import:
  dcc: dash_core_components
  html: dash_html_components
  daq: dash_daq
  dac: dash_audio_components
  dbc: dash_bootstrap_components
  dex: dash_extensions


app:
  jupyter_dash.JupyterDash:
    external_stylesheets:
      - https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css
      - https://codepen.io/chriddyp/pen/bWLwgP.css
      # - https://cdn.clarkhacks.com/OpenDyslexic/v3/OpenDyslexic.css
    external_scripts:
      - https://surikov.github.io/webaudiofont/npm/dist/WebAudioFontPlayer.js
      - https://surikov.github.io/webaudiofontdata/sound/0250_SoundBlasterOld_sf2.js
      - https://surikov.github.io/webaudiofontdata/sound/0240_Chaos_sf2_file.js
    title: Market Audiolizer
    suppress_callback_exceptions: True


A0: 1.4393326938302626 # low A (log10)
C3: 2.116650241674698
C5: 2.7187101500034196
C8: 3.6217992240026677 # high C (log10)

run_server:
  host: '0.0.0.0'
  port: 8050
  extra_files:
    - audiolizer.yaml
  debug: True
  dev_tools_hot_reload: False


nav:
  dbc.Navbar:
    color: dark
    children:
      - html.A:
          children:
            - dbc.Row:
                align: center
                justify: between
                children:
                  - dbc.Col:
                      width: 4
                      children:
                      - html.Img:
                          id: logo
                          src: https://github.com/asherp/audiolizer/raw/master/docs/assets/audiolizer_icon.jpg
                          height: 35px
                  - dbc.Col:
                      width: 4
                      children:
                      - dbc.NavbarBrand:
                          children:
                            html.H6: How It Works
                          # className: ml-3
          href: https://audiolizer.github.io/audiolizer/
    dark: True

player_settings:
  - dbc.Col:
      width: 5
      children: 
        - html.H2: Market Audiolizer
        - dcc.Loading:
            id: loading
            type: default
            children:
              - html.Div:
                  id: loading-output
                  children: loading output
  - dbc.Col:
      width:
        xs: 12
        sm: 12
        md: 12
        lg: 4
        xl: 4
      children:
        - html.Br:
        - dbc.Row:
            children:
            - dbc.Col:
                width: 12
                children:
                - 'midi player'
            - dbc.Col:
                width: 12
                children:
                - html.A:
                    id: midi_download
                    children: Download MIDI
                    href: ''
                    download: ''
  - dbc.Col:
      width:
        xs: 12
        sm: 12
        md: 12
        lg: 3
        xl: 3
      children:
        - html.Br:
        - html.Button:
            id: play
            n_clicks: 0
            children: Play
        - html.Div:
            id: play-clicks
            style:
              display: none
  - dbc.Col:
      width:
        xs: 12
        sm: 12
        md: 12
        lg: 3
        xl: 3
      children:
        - html.Br:
        - html.Button:
            id: stop
            n_clicks: 0
            children: stop
        - html.Div:
            id: stop-clicks
            style:
              display: none
  - dbc.Col:
      width:
        xs: 12
        sm: 12
        md: 12
        lg: 3
        xl: 3
      children:
        - html.Br:
        - dcc.Input:
            id: timestamp-input
            value: ''
            # type: hidden

date_settings:
  - dbc.Row:
      align: center
      no_gutters: True
      children:
        - dbc.Col:
            align: center
            width: auto
            children:
              - dbc.Select:
                  id: base
                  options:
                    - label: BTC
                      value: BTC
                  value: BTC
                  required: True
                  bs_size: lg
        - dbc.Col:
            align: center
            width: auto
            children: /
        - dbc.Col:
            align: center
            width: auto
            children:
              - dbc.Select:
                  id: quote
                  options:
                    - label: USD
                      value: USD
                  value: USD
                  required: True
                  bs_size: lg
  - dbc.Row:
      children:
        - dbc.Col:
            width:
              size: 10
              offset: 1
            children:
            - dbc.RadioItems:
                id: date-select
                options:
                  - label: '1D'
                    value: '24H-15T'
                  - label: '1W'
                    value: '1W-4H'
                  - label: '1M'
                    value: '30D-1D'
                  - label: '6M'
                    value: '180D-1D'
                  - label: '1Y'
                    value: '365D-7D'
                value: '24H-15T'
                inline: True
  - dbc.Row:
      children:
        dbc.Col:
          width: auto
          children:
          - dcc.DatePickerRange:
              id: date-range
              min_date_allowed: 2001-01-01
              max_date_allowed:
              initial_visible_month: 2021-01-01
              start_date: 2021-01-01
              end_date:
  - dbc.Row:
      children:
        - dbc.Col:
            width:
              size: 6
            children:
            - dbc.Select:
                id: cadence
                options:
                  - label: weekly
                    value: 7D
                  - label: daily
                    value: 1D
                  - label: 4hour
                    value: 4H
                  - label: 1hour
                    value: 1H
                  - label: 15m
                    value: 15T
                required: True
                value: 7D
                bs_size: lg

instrument_settings:
  - dcc.Dropdown:
      id: category
      clearable: False
  - dcc.Dropdown:
      id: instrument-type
      clearable: False
  - dcc.Dropdown:
      id: instrument
      clearable: False
  - html.Div:
      id: out-component
      children: 'True'

scale_settings:
  - dbc.Row:
      children:
        dbc.Col:
          width:
            size: 10
          children:
          - dcc.RangeSlider:
              id: frequency-drag
              min: ${A0}
              max: ${C8}
              step: .1
              value:
                - ${C3}
                - ${C5}
  - dbc.Row:
      children:
        dbc.Col:
          width:
            size: 10
            offset: 1
          children:  
          - dbc.Checklist:
              id: price_type
              options:
                - label: open
                  value: open
                - label: close
                  value: close
                - label: high
                  value: high
                - label: low
                  value: low
              value:
                - close
              inline: True

duration_settings:
  dbc.Row:
    children:
    - dbc.Col:
        width: 4
        children:
        - daq.NumericInput:
            id: drop-quantile
            min: 0
            max: 100
            value: 0
            label: rest quantile
    - dbc.Col:
        width: 4
        children:
        - daq.NumericInput:
            id: beat-quantile
            min: 0
            max: 100
            value: 0
            label: beat quantile
    - dbc.Col:
        width: 4
        children:
        - daq.NumericInput:
            id: tempo
            min: 24
            max: 240
            value: 240
            label: tempo BPM

pitch_settings:
  - dbc.Row:
      children:
      - dbc.Col:
          width:
            size: 3
            offset: 2
          children:
          - daq.ToggleSwitch:
              id: toggle-merge
              label: merge
              value: True
              labelPosition: bottom
      - dbc.Col:
          width:
            size: 3
          children:
          - daq.ToggleSwitch:
              id: toggle-silence
              label: rests
              value: True
              labelPosition: bottom

storage:
  dcc.Store:
    id: midi-data

layout:
  dbc.Container:
    fluid: True
    children:
    - dcc.Location:
        id: url
        refresh: False
    - ${nav}
    - dbc.Row:
        justify: left
        align: left
        children: ${player_settings}
    - html.Hr:
    - dbc.Row:
        no_gutters: True
        children:
          - dbc.Col:
              xs: 12
              sm: 12
              md: 6
              lg: 6
              xl: 3
              children: ${date_settings}
          - dbc.Col:
              xs: 12
              sm: 12
              md: 6
              lg: 6
              xl: 3
              children: ${instrument_settings}
          - dbc.Col:
              xs: 12
              sm: 12
              md: 6
              lg: 6
              xl: 3
              children: ${scale_settings}
          - dbc.Col:
              xs: 12
              sm: 12
              md: 6
              lg: 6
              xl: 3
              children: ${duration_settings}
          - dbc.Col:
              xs: 12
              sm: 12
              md: 6
              lg: 6
              xl: 3
              children: ${pitch_settings}
    - dbc.Row:
        id: debug
    - dbc.Row:
        children:
          - dbc.Col:
              children:
              - dcc.Graph:
                  id: candlestick-chart
                  animate: False
    - html.Div:
        id: data_dump
    - html.Div:
        id: preset-path
        children: ''
    - dcc.Store:
        id: midi-data
    - html.Div:
        id: midi-display
    - html.Div:
        id: candlestick-data-render
    - dcc.Store:
        id: candlestick-data
    - dex.EventListener:
        id: timestamp-listener
        events:
          - event: change
            props:
              - srcElement.value
        logging: True
        # children:
        # - html.Div:
        #     id: dummy-div
    - html.Div:
        id: log


callbacks:
  update_base_options:
    input:
      - id: url
        attr: pathname
    output:
      - id: base
        attr: options

  update_quote_options:
    input:
      - id: base
        attr: value
    state:
      - id: quote
        attr: value
    output:
      - id: quote
        attr: value
      - id: quote
        attr: options

  update_date_range:
    input:
      - id: date-select
        attr: value
    output:
      - id: date-range
        attr: start_date
      - id: date-range
        attr: end_date
      - id: cadence
        attr: value
      - id: date-range
        attr: initial_visible_month

  play:
    input:
      - id: base
        attr: value
      - id: quote
        attr: value
      - id: date-range
        attr: start_date
      - id: date-range
        attr: end_date
      - id: cadence
        attr: value
      - id: frequency-drag
        attr: value
      - id: drop-quantile
        attr: value
      - id: beat-quantile
        attr: value
      - id: tempo
        attr: value
      - id: toggle-merge
        attr: value
      - id: toggle-silence
        attr: value
      # - id: candlestick-chart
      #   attr: selectedData
      - id: price_type
        attr: value
    output:
      - id: candlestick-data
        attr: data
      - id: midi-data
        attr: data
      - id: midi_download
        attr: href
      - id: midi_download
        attr: download
      - id: loading-output
        attr: children

  # render_selected_data:
  #   input:
  #     - id: candlestick-data
  #       attr: data
  #   output:
  #     - id: candlestick-data-render
  #       attr: children

  slider_marks:
    input:
      - id: url
        attr: pathname
    output:
      - id: frequency-drag
        attr: marks

  choose_category:
    input:
      - id: url
        attr: pathname
    output:
      - id: category
        attr: options
      - id: category
        attr: value
    callback: midi_loader.fetch_instrument_categories

  choose_instrument_types:
    input:
      - id: category
        attr: value
    output:
      - id: instrument-type
        attr: options
      - id: instrument-type
        attr: value
    callback: midi_loader.fetch_instrument_types

  choose_instrument:
    input:
      - id: category
        attr: value
      - id: instrument-type
        attr: value
    output:
      - id: instrument
        attr: options
      - id: instrument
        attr: value
    callback: midi_loader.fetch_instruments

  instrument_path:
    input:
      - id: instrument
        attr: value
    output:
      - id: preset-path
        attr: children
    callback: midi_loader.fetch_instrument_path


  # midi_display:
  #   input:
  #     - id: midi-data
  #       attr: data
  #   output:
  #     - id: midi-display
  #       attr: children


